--- 
title: "Cancer Deaths Rate Research"
author: "Yingtong Peng and Xiaoran Hu"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
--- 
title: "Cancer Deaths Rate Research"
author: "Yingtong Peng and Xiaoran Hu"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction
This data is chosen because we are concerned about health problems, especially cancer. In the United States, more than 1.6 million of people are diagnosed with cancer each year, around 600000 people die because of cancer. Cancer has been regarded as the second leading cause of death. Thus, what effects cancer death rate becomes an important topic for researchers. In this project, the relationship between potential factors and cancer deaths is studied. The three main questions we are interested in are: 1. What are the variables that have relationship with cancer incidence counts? The potential variables we want to study are leading cancer site, sex, race and region. 2. For a certain cancer, does gender has an effect for this cancer? We focus on breast cancer, as NCI stated that some new studies suggested men may be more likely than women to die after being diagnosed with breast cancer, particularly during the first 5 years after diagnosis(https://www.cancer.gov/news-events/cancer-currents-blog/2019/male-breast-cancer-higher-mortality), we assume that gender effect the incidence counts for breast cancer. We want to check this assumption. 3. Does the death rate change with the increasing year of diagnosis? Due to the development of medical techniques, the death rate may decrease with the increasing year of diagnosis. Whether this assumption is correct needs to be checked.

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources

The data comes from the Centers for Disease Control and Prevention (CDC) and the link to the data is https://wonder.cdc.gov/cancer.html. The data was from The United States Cancer Statistics (USCS) which are the official federal statistics on cancer incidence from registries having high-quality data and cancer mortality statistics for 50 states and the District of Columbia. And USCS are produced by CDC and the National Cancer Institute (NCI). All of USCS contributors and partners are responsible for collecting this data. Since our data contains incidence data and mortality data, the incidence data are provided by The Centers for Disease Control and Prevention National Program of Cancer Registries (NPCR), The National Cancer Institute Surveillance, Epidemiology and End Results (SEER) program, and The Centers for Disease Control and Prevention National Vital Statistics System (NVSS). Cancer mortality data for deaths after 2018 are available from NVSS. There are several choices to request a data form, firstly we choose group results by leading cancer sites and by year, sex, race, and region, then choose measures to contain death counts and incidence counts. Secondly, we select locations by state. Finally, we choose data to contain all year, sex, race, and region.


This data contains some information about leading cancer sites, mortality-incidence rate which is age-adjusted, and patientsâ€™ personal information such as sex, race, region, and year of diagnosis. Among our dataset, Leading Cancer Sites, Year, Sex, Race, Region are categorical variables, and Mortality-Incidence Age-Adjusted Rate Ratio, Death Counts, Incidence Counts are continuous variables. The data contains 11264 observations.


Interestingly, we find that the death counts in some observations are 0, which means that no death in that observation, resulting in the morality-incidence rate ratio being not applicable.

<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation

This data contains both the data and metadata. We can separate them into two data frames, one for data and the other one for metadata and store them separately.
Here is our data:
```{r}
library(tidyverse)
cancer<-read_tsv("United States and Puerto Rico Cancer Statistics, 1999-2018 Mortality Incidence Rate Ratios.txt")
dat<-cancer[1:11263,] %>%
  select(-Notes)
head(dat)

```

The metadata is following:
```{r}
notes <- cancer |> 
  dplyr::filter(!is.na(Notes)) |> 
  select(Notes)
write_csv(notes, "querynotes.csv")
read_csv("querynotes.csv") |> head(20)
```


<!--chapter:end:03-cleaning.Rmd-->


# Missing values

Placeholder



<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results
```{r}
library(tidyverse)
##replace NAs by zeros
datrna <- datnew %>%
  mutate(`Mortality-Incidence Age-Adjusted Rate Ratio` = replace_na(`Mortality-Incidence Age-Adjusted Rate Ratio`,0))
```

```{r}
datic <- datrna %>%
  mutate(`Incidence Counts` = ifelse(`Incidence Counts`<500, "< 500", ifelse(`Incidence Counts` >= 500&`Incidence Counts`<1000, "500-1000", ifelse(`Incidence Counts` >= 1000&`Incidence Counts`<1500, "1000-1500", ifelse(`Incidence Counts` >= 1500&`Incidence Counts`<2000, "1500-2000", "> 2000")))))
head(datic)
```

```{r}
attach(datic)
library(vcd)
library(RColorBrewer)
colors <- brewer.pal(5, "Set2")
ic = fct_rev(datic$`Incidence Counts`)
lcs = datic$`Leading Cancer Sites`
mosaic(ic ~ lcs, dat = datic, direction = c("v", "h"), highlighting_fill = colors,
       rot_labels = 0, tl_labels = FALSE)
```

```{r}
mosaic(ic ~ Sex, data = datic, direction = c("v", "h"), highlighting_fill = colors,
       rot_labels = 0, tl_labels = FALSE)
```

```{r}
datic <- datic %>%
  mutate(Race = case_when(grepl("Black",Race) ~ "Black",
                          grepl("Asian",Race) ~ "Asian",
                          grepl("White",Race) ~ "White",
                          grepl("Indian",Race) ~ "Indian",
                          grepl("Other",Race) ~ "Other"))
mosaic(ic ~ Race, data = datic, direction = c("v", "h"), highlighting_fill = colors,
       rot_labels = 0, tl_labels = FALSE)
```
```{r}
mosaic(ic ~ Region, data = datic, direction = c("v", "h"), highlighting_fill = colors,
       rot_labels = 0, tl_labels = FALSE)
```
Race seems to have the strongest association with Incidence counts.

```{r}
counts1 <- datrna %>%
  group_by(`Leading Cancer Sites`) %>%
  dplyr::summarize(Freq = sum(`Incidence Counts`)) %>%
  arrange(desc(Freq))
counts1
```
### Q2.
```{r}
library(ggplot2)
breast <- datic %>%
  filter(`Leading Cancer Sites` == "Breast") %>%
  mutate(Year = ifelse(Year <= 2002, "1999-2002", ifelse(Year > 2002 & Year<=2006, "2002-2006", ifelse(Year > 2006 & Year<=2010, "2006-2010", ifelse(Year > 2010 & Year<=2014, "2010-2014", "2014-2018")))))

ggplot(breast, aes(Sex, `Mortality-Incidence Age-Adjusted Rate Ratio`)) +
  geom_boxplot() + coord_flip() +
  theme_grey(16)
```

```{r}
library(ggridges)
ggplot(breast,aes(`Mortality-Incidence Age-Adjusted Rate Ratio`, Sex)) +
  geom_density_ridges(fill = "cornflowerblue", alpha = .5, scale = 1) +
  ylab("")
```


```{r}
breastsex <- breast %>%
  group_by(Sex, Year) %>%
  dplyr::summarize(rate = mean(`Mortality-Incidence Age-Adjusted Rate Ratio`, na.rm = TRUE))
ggplot(breastsex, aes(Sex, rate)) +
  geom_col() +
  xlab("Gender") +
  facet_wrap(~Year)
```



```{r}
top_cancer <- datrna %>% 
  group_by(`Leading Cancer Sites`) %>% 
  summarize(rate = mean(`Mortality-Incidence Age-Adjusted Rate Ratio`, na.rm = TRUE)) %>% 
  slice_max(n = 12, order_by = rate) %>%
  pull(`Leading Cancer Sites`)
top_cancer
```

```{r}
datrna %>%
  filter(`Leading Cancer Sites` %in% top_cancer) %>%
  dplyr::select(`Leading Cancer Sites`, `Mortality-Incidence Age-Adjusted Rate Ratio`) %>%
  group_by(`Leading Cancer Sites`) %>% 
  summarize(rate = mean(`Mortality-Incidence Age-Adjusted Rate Ratio`, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(rate, reorder(`Leading Cancer Sites`, rate))) +
  geom_point() +
  ggtitle("Top 12 of Leading Cancer Sites by mean motality ratio") +
  labs(x='mean motality ratio', y='Leading Cancer Sites') +
  theme_bw()
```
```{r}
dftop <- datrna %>%
  filter(`Leading Cancer Sites` %in% top_cancer) %>%
  dplyr::select(Year, `Leading Cancer Sites`, `Mortality-Incidence Age-Adjusted Rate Ratio`) %>%
  mutate(Year = ifelse(Year <= 2002, "1999-2002", ifelse(Year > 2002 & Year<=2006, "2002-2006", ifelse(Year > 2006 & Year<=2010, "2006-2010", ifelse(Year > 2010 & Year<=2014, "2010-2014", "2014-2018"))))) %>%
  group_by(`Leading Cancer Sites`, Year) %>% 
  summarize(rate = mean(`Mortality-Incidence Age-Adjusted Rate Ratio`, na.rm = TRUE)) %>% 
  mutate(rate = ifelse(rate < 0.4, "Low", ifelse(rate >= 0.4&rate<0.6, "Medium", "High")))
head(dftop)
```

```{r}
library(ggalluvial)

ggplot(dftop, aes(x = Year, y = 1, stratum = rate, alluvium = `Leading Cancer Sites` , label = rate)) +
  geom_alluvium(color = "grey50") +
  geom_stratum(aes(fill = rate), alpha = .4, color = NA) +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 3) +
  geom_text(stat = "alluvium", aes(label = ifelse(Year == "1999-2002", `Leading Cancer Sites`, NA)), size = 2.5,
            hjust = "outward", nudge_x = -.10) +
  geom_text(stat = "alluvium", aes(label = ifelse(Year == "2014-2018", `Leading Cancer Sites`, NA)), size = 2.5,
            hjust = "outward", nudge_x = .10) +
  scale_y_reverse(breaks = NULL) +
  scale_fill_manual(values = colors, guide = guide_legend(reverse = FALSE)) +
  xlab("") +
  ylab("Leading Cancer Sites") +
  theme_bw()
```

```{r}
ggplot(dftop, aes(Year, `Leading Cancer Sites`,fill = rate)) +
  geom_tile(color = "white", lwd = .25) +
  coord_fixed() +
  scale_fill_manual(values = colors) +
  ylab("Leading Cancer Sites") +
  theme_classic() +
  theme(legend.position = "bottom") + 
  coord_fixed(ratio=0.3)
```


<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component



<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

